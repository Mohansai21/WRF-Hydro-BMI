---
phase: 01-fpic-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bmi_wrf_hydro/rebuild_fpic.sh
  - bmi_wrf_hydro/build.sh
autonomous: true
requirements:
  - BUILD-01
must_haves:
  truths:
    - "All WRF-Hydro static libraries in build_fpic/lib/ are compiled with explicit -fPIC via CMAKE_POSITION_INDEPENDENT_CODE=ON"
    - "The existing 151-test BMI suite passes when linked against build_fpic/ libraries (no regression)"
    - "readelf confirms PIC relocations in rebuilt object files (zero R_X86_64_32S relocations)"
    - "build.sh --fpic links BMI wrapper against build_fpic/ libraries instead of build/"
    - "build.sh without --fpic still uses original build/ libraries (backward compatible)"
  artifacts:
    - path: "bmi_wrf_hydro/rebuild_fpic.sh"
      provides: "fPIC rebuild script that invokes cmake on WRF-Hydro with -fPIC and runs regression tests"
      min_lines: 60
    - path: "bmi_wrf_hydro/build.sh"
      provides: "Updated build script with --fpic flag support"
      contains: "--fpic"
    - path: "wrf_hydro_nwm_public/build_fpic/lib/"
      provides: "Rebuilt static libraries with position-independent code"
  key_links:
    - from: "bmi_wrf_hydro/rebuild_fpic.sh"
      to: "wrf_hydro_nwm_public/CMakeLists.txt"
      via: "cmake -DCMAKE_POSITION_INDEPENDENT_CODE=ON invocation"
      pattern: "CMAKE_POSITION_INDEPENDENT_CODE"
    - from: "bmi_wrf_hydro/rebuild_fpic.sh"
      to: "bmi_wrf_hydro/build.sh"
      via: "calls build.sh --fpic full to run regression tests"
      pattern: "build\\.sh.*--fpic"
    - from: "bmi_wrf_hydro/build.sh"
      to: "wrf_hydro_nwm_public/build_fpic/lib/"
      via: "--fpic flag switches WRF_BUILD path"
      pattern: "build_fpic"
---

<objective>
Rebuild WRF-Hydro's static libraries with explicit position-independent code (-fPIC) and update the BMI build system to link against them.

Purpose: The fPIC-compiled static libraries are the prerequisite for Phase 2, which links them into a shared object (`libwrfhydrobmi.so`). Without -fPIC, the linker will reject static archives during shared library creation. Although the current compiler defaults to PIC, making the flag explicit ensures portability and documents the requirement.

Output: `rebuild_fpic.sh` script, updated `build.sh` with `--fpic` flag, rebuilt libraries in `wrf_hydro_nwm_public/build_fpic/`, and verified 151-test regression suite passing.
</objective>

<execution_context>
@/home/mohansai/.claude/get-shit-done/workflows/execute-plan.md
@/home/mohansai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fpic-foundation/01-CONTEXT.md
@.planning/phases/01-fpic-foundation/01-RESEARCH.md
@bmi_wrf_hydro/build.sh
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rebuild_fpic.sh and update build.sh with --fpic flag</name>
  <files>bmi_wrf_hydro/rebuild_fpic.sh, bmi_wrf_hydro/build.sh</files>
  <action>
**Part A: Create `bmi_wrf_hydro/rebuild_fpic.sh`**

Create a bash script that rebuilds WRF-Hydro with explicit -fPIC. The script must:

1. **Shebang + set -e** for error handling
2. **Activate conda environment:** `source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi`
3. **Define paths:**
   - `BMI_DIR="$(cd "$(dirname "$0")" && pwd)"`
   - `WRF_SRC="${BMI_DIR}/../wrf_hydro_nwm_public"`
   - `BUILD_DIR="${WRF_SRC}/build_fpic"`
4. **Clean previous build:** `rm -rf "${BUILD_DIR}"` (per research: avoid stale CMakeCache.txt)
5. **Configure cmake:**
   ```bash
   cmake -B "${BUILD_DIR}" \
     -S "${WRF_SRC}" \
     -DCMAKE_BUILD_TYPE=Release \
     -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
     -DCMAKE_Fortran_COMPILER="$(which gfortran)" \
     -DCMAKE_C_COMPILER="$(which gcc)"
   ```
   - Explicitly pass conda gfortran/gcc (per research Finding 1: avoids picking up system `/usr/bin/f95`)
6. **Build:** `cmake --build "${BUILD_DIR}" -j$(nproc)`
7. **Verify PIC:** After build, run `readelf -r` on a sample library to check for `R_X86_64_32S` relocations. Print count. Zero = confirmed PIC. Use the largest library (`libhydro_routing.a`) as the sample:
   ```bash
   NON_PIC_COUNT=$(readelf -r "${BUILD_DIR}/lib/libhydro_routing.a" 2>/dev/null | grep -c 'R_X86_64_32S' || true)
   echo "Non-PIC relocations in libhydro_routing.a: ${NON_PIC_COUNT}"
   if [ "$NON_PIC_COUNT" -ne 0 ]; then
     echo "ERROR: Non-PIC relocations found! -fPIC may not have been applied."
     exit 1
   fi
   echo "PIC verification: PASSED"
   ```
8. **Count libraries:** List all `.a` files in `build_fpic/lib/` and print the count (expected: 24 per research Finding 7).
9. **Run regression tests:** Call `build.sh --fpic full` to compile BMI wrapper against fPIC libs, then run the 151-test suite:
   ```bash
   cd "${BMI_DIR}"
   ./build.sh --fpic full
   echo ""
   echo "=== Running 151-test BMI regression suite ==="
   mpirun --oversubscribe -np 1 ./build/bmi_wrf_hydro_test
   ```
10. **Make executable:** Script must be `chmod +x`.

Add a header comment block explaining the script's purpose, usage, and that it does NOT modify WRF-Hydro source files.

**Part B: Update `bmi_wrf_hydro/build.sh` with `--fpic` flag**

Modify the existing `build.sh` to support a `--fpic` flag:

1. **Parse the `--fpic` flag** at the top of the script, BEFORE the BUILD_TARGET parsing. Scan all arguments for `--fpic` and set `USE_FPIC="true"`. Remove `--fpic` from the argument list so BUILD_TARGET parsing still works. Implementation:
   ```bash
   USE_FPIC="false"
   ARGS=()
   for arg in "$@"; do
     case "$arg" in
       --fpic) USE_FPIC="true" ;;
       *) ARGS+=("$arg") ;;
     esac
   done
   BUILD_TARGET="${ARGS[0]:-all}"
   ```
   This replaces the current `BUILD_TARGET="${1:-all}"` line.

2. **Switch WRF_BUILD path** based on the flag. After the `BMI_DIR` definition, add the conditional:
   ```bash
   if [ "$USE_FPIC" = "true" ]; then
     WRF_BUILD="${BMI_DIR}/../wrf_hydro_nwm_public/build_fpic"
     echo "*** Using fPIC libraries from build_fpic/ ***"
   else
     WRF_BUILD="${BMI_DIR}/../wrf_hydro_nwm_public/build"
   fi
   ```
   The three derived paths (`WRF_MODS`, `WRF_LIB`, `WRF_OBJ`) are already computed from `WRF_BUILD`, so they automatically switch.

3. **Verify `build_fpic/` exists** when `--fpic` is used:
   ```bash
   if [ "$USE_FPIC" = "true" ] && [ ! -d "$WRF_BUILD" ]; then
     echo "ERROR: ${WRF_BUILD} not found. Run rebuild_fpic.sh first."
     exit 1
   fi
   ```

4. **Update the usage comment** at the top of the script to document the `--fpic` flag:
   ```
   #   ./build.sh --fpic         Build all using fPIC WRF-Hydro libraries
   #   ./build.sh --fpic full    Build full test using fPIC libraries
   ```

5. **Preserve all existing functionality** -- default behavior (no --fpic) must be identical to current behavior.
  </action>
  <verify>
1. `bash -n bmi_wrf_hydro/rebuild_fpic.sh` -- syntax check passes (no errors)
2. `bash -n bmi_wrf_hydro/build.sh` -- syntax check passes (no errors)
3. `grep -c 'CMAKE_POSITION_INDEPENDENT_CODE' bmi_wrf_hydro/rebuild_fpic.sh` returns 1
4. `grep -c 'build_fpic' bmi_wrf_hydro/build.sh` returns at least 2 (the path and the error message)
5. `grep -c '\-\-fpic' bmi_wrf_hydro/build.sh` returns at least 3 (parsing + usage comments)
  </verify>
  <done>
  - `rebuild_fpic.sh` exists, is executable, contains cmake invocation with `-DCMAKE_POSITION_INDEPENDENT_CODE=ON`, outputs to `build_fpic/`, includes PIC verification via readelf, and calls `build.sh --fpic full` + regression test at the end
  - `build.sh` accepts `--fpic` flag, switches to `build_fpic/` libraries when flag is present, defaults to `build/` when absent, and validates `build_fpic/` directory exists when `--fpic` is used
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute fPIC rebuild and verify 151-test regression suite</name>
  <files>wrf_hydro_nwm_public/build_fpic/</files>
  <action>
Run the rebuild_fpic.sh script to actually build the fPIC libraries and verify the regression test suite passes. This is the real execution step -- Task 1 wrote the scripts, Task 2 runs them.

1. **Ensure working directory is correct:** The 151-test suite must be run from `bmi_wrf_hydro/` (it reads config files relative to `../WRF_Hydro_Run_Local/run/`). Set up by:
   ```bash
   cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/bmi_wrf_hydro
   ```

2. **Run the rebuild script:**
   ```bash
   ./rebuild_fpic.sh
   ```
   This will:
   - Clean and configure cmake with -fPIC (expect ~1-2 min)
   - Build all libraries (expect ~2-10 min on WSL2)
   - Verify PIC via readelf
   - Compile BMI wrapper against fPIC libs via `build.sh --fpic full`
   - Run `mpirun --oversubscribe -np 1 ./build/bmi_wrf_hydro_test`

3. **Expected output verification:**
   - cmake configure: completes without errors
   - cmake build: all 22+ libraries compile successfully
   - PIC check: "Non-PIC relocations in libhydro_routing.a: 0" and "PIC verification: PASSED"
   - Library count: 24 `.a` files in `build_fpic/lib/`
   - build.sh --fpic: "BUILD SUCCESSFUL"
   - 151-test suite: "PASSED: 151/151" (or similar pass count message)

4. **If the rebuild fails:**
   - Check cmake output for missing MPI/NetCDF (conda env not activated)
   - Check for stale CMakeCache.txt (should be impossible since script rm -rf's first)
   - Check compiler path in CMakeCache.txt is conda gfortran, not system

5. **If tests fail:**
   - Compare with original build test output to identify which tests differ
   - Check if any link errors indicate missing symbols (would point to library path issues)
   - Verify `WRF_OBJ` path matches the object file layout in `build_fpic/`

6. **After successful run, verify independently:**
   ```bash
   # Check library count
   ls wrf_hydro_nwm_public/build_fpic/lib/*.a | wc -l
   # Expected: 24

   # Check PIC on all libraries (not just sample)
   for lib in wrf_hydro_nwm_public/build_fpic/lib/*.a; do
     count=$(readelf -r "$lib" 2>/dev/null | grep -c 'R_X86_64_32S' || true)
     if [ "$count" -ne 0 ]; then
       echo "FAIL: $lib has $count non-PIC relocations"
     fi
   done
   echo "All libraries verified PIC"

   # Check cmake used correct compiler
   grep CMAKE_Fortran_COMPILER:FILEPATH wrf_hydro_nwm_public/build_fpic/CMakeCache.txt
   # Expected: path contains miniconda3/envs/wrfhydro-bmi, NOT /usr/bin/f95
   ```

**IMPORTANT:** This task involves running a full WRF-Hydro rebuild which takes 2-10 minutes. The 151-test suite takes another 2-3 minutes. Set an appropriate timeout (10 minutes = 600000ms for the rebuild step).

**NOTE:** If for any reason the full execution cannot complete within the Claude session (e.g., timeout), document the partial result and the exact command to resume. The user can run the remaining commands manually.
  </action>
  <verify>
1. `ls wrf_hydro_nwm_public/build_fpic/lib/*.a | wc -l` returns 24
2. `readelf -r wrf_hydro_nwm_public/build_fpic/lib/libhydro_routing.a 2>/dev/null | grep -c R_X86_64_32S` returns 0
3. `grep CMAKE_Fortran_COMPILER:FILEPATH wrf_hydro_nwm_public/build_fpic/CMakeCache.txt` shows conda gfortran path
4. The 151-test BMI suite output shows all tests passed (151/151 or equivalent)
5. `build.sh` without `--fpic` still references `build/` (run: `grep 'WRF_BUILD=' bmi_wrf_hydro/build.sh` to confirm default path)
  </verify>
  <done>
  - `wrf_hydro_nwm_public/build_fpic/lib/` contains 24 `.a` libraries compiled with explicit -fPIC
  - All 24 libraries have zero `R_X86_64_32S` non-PIC relocations (verified via readelf)
  - CMakeCache.txt confirms conda gfortran was used (not system gfortran)
  - BMI 151-test suite passes against fPIC-rebuilt libraries (no regression from original build)
  - Both library sets coexist: `build/` (original) and `build_fpic/` (fPIC)
  </done>
</task>

</tasks>

<verification>
Phase 1 is complete when ALL of these are true:

1. **Script existence:** `bmi_wrf_hydro/rebuild_fpic.sh` exists and is executable
2. **build.sh updated:** `bmi_wrf_hydro/build.sh` supports `--fpic` flag, backward compatible without it
3. **fPIC libraries built:** `wrf_hydro_nwm_public/build_fpic/lib/` contains 24 `.a` files
4. **PIC confirmed:** Zero `R_X86_64_32S` relocations across all rebuilt libraries
5. **Correct compiler:** CMakeCache.txt shows conda gfortran, not system gfortran
6. **Regression passed:** 151/151 BMI tests pass when linked against `build_fpic/` libraries
7. **Backward compat:** `build.sh` without `--fpic` still uses original `build/` libraries
8. **Both coexist:** `build/` and `build_fpic/` directories both present under `wrf_hydro_nwm_public/`
</verification>

<success_criteria>
- BUILD-01 satisfied: WRF-Hydro static libraries compiled with explicit `-fPIC` via `CMAKE_POSITION_INDEPENDENT_CODE=ON`
- Zero regression: 151-test BMI suite passes identically against fPIC libraries
- Phase 2 unblocked: fPIC libraries ready for shared library linking
</success_criteria>

<output>
After completion, create `.planning/phases/01-fpic-foundation/01-01-SUMMARY.md`
</output>
