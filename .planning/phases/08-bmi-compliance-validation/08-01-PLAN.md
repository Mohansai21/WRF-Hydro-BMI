# Plan 08-01: Run bmi-tester + Fix Failures + Regression Test

**Phase:** 8 — BMI Compliance Validation
**Goal:** All 4 bmi-tester stages (bootstrap + stages 1-3) pass against pymt_wrfhydro with Croton NY data
**Requirements:** VAL-01, VAL-02, VAL-03, VAL-05

## Pre-conditions
- [x] pymt_wrfhydro installed and importable (Phase 7 complete)
- [x] bmi-tester 0.5.9 installed in wrfhydro-bmi conda env
- [x] Croton NY test case at WRF_Hydro_Run_Local/run/
- [x] libbmiwrfhydrof.so installed at $CONDA_PREFIX/lib/

## Tasks

### Task 1: Prepare bmi-tester Config
**What:** Create a BMI config file in the Croton NY run directory for bmi-tester
**Files:** WRF_Hydro_Run_Local/run/bmi_config.nml
**Commands:**
```bash
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI
# Config file likely already exists from Phase 7 tests — verify or create
cat WRF_Hydro_Run_Local/run/bmi_config.nml
```
**Verify:** File exists with `wrfhydro_run_dir` set to absolute path

### Task 2: First bmi-tester Run (Diagnostic)
**What:** Run bmi-tester to capture all failures before fixing anything
**Commands:**
```bash
source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/WRF_Hydro_Run_Local/run/
mpirun --oversubscribe -np 1 bmi-test pymt_wrfhydro:WrfHydroBmi \
    --root-dir . --config-file bmi_config.nml -v 2>&1 | tee /tmp/bmi-tester-run1.log
```
**Capture:** Full stdout/stderr for analysis. If it fails at bootstrap, analyze bootstrap first.
**Expected:** Some failures — this is the diagnostic run.

### Task 3: Analyze Failures
**What:** Categorize each failure into:
1. **BMI wrapper bug** → fix in bmi_wrf_hydro.f90
2. **Cython bridge bug** → fix in wrfhydrobmi.pyx or __init__.py
3. **Config/setup issue** → fix config file or --root-dir usage
4. **Expected non-implementation** → document (get_value_ptr, grid topology)
5. **bmi-tester limitation** → workaround or skip

**Key things to check per failure:**
- Which stage failed?
- Which test function failed?
- What was the assertion error?
- Is it a bug in our code or a bmi-tester expectation we can't meet?

### Task 4: Fix BMI Wrapper Issues
**What:** Fix any bugs discovered in bmi_wrf_hydro.f90
**Potential fixes (based on research):**
- Unit strings: If gimli rejects `"m3 s-1"` or `"1"`, update to accepted format
- Grid topology: If bmi-tester expects edge_nodes for vector grid, provide data from channel connectivity
- Any other issues discovered in Task 3

**After fix:**
```bash
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/bmi_wrf_hydro
./build.sh --shared  # Rebuild .so + install to $CONDA_PREFIX + run 151 Fortran tests
```

### Task 5: Rebuild pymt_wrfhydro (If Wrapper Changed)
**What:** Reinstall pymt_wrfhydro so it picks up the rebuilt .so
**Commands:**
```bash
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/pymt_wrfhydro
pip install --no-build-isolation .
```

### Task 6: Re-run bmi-tester (Validation)
**What:** Run bmi-tester again after fixes — iterate until all stages pass
**Commands:**
```bash
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/WRF_Hydro_Run_Local/run/
mpirun --oversubscribe -np 1 bmi-test pymt_wrfhydro:WrfHydroBmi \
    --root-dir . --config-file bmi_config.nml -v 2>&1 | tee /tmp/bmi-tester-run2.log
```
**Gate:** ALL stages must show PASSED. If not, go back to Task 3-5.

### Task 7: Regression Testing
**What:** Verify existing tests still pass after any BMI wrapper changes
**Commands:**
```bash
# 1. Fortran 151-test suite (runs automatically in build.sh --shared)
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/bmi_wrf_hydro
mpirun --oversubscribe -np 1 ./build/bmi_wrf_hydro_test

# 2. Python 38-test pytest suite
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/pymt_wrfhydro
mpirun --oversubscribe -np 1 python -m pytest tests/test_bmi_wrfhydro.py -v

# 3. Standalone E2E script
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/pymt_wrfhydro
mpirun --oversubscribe -np 1 python tests/test_e2e_standalone.py
```
**Gate:** All 3 suites pass. No regressions.

### Task 8: Save bmi-tester Logs
**What:** Save final passing bmi-tester output for Doc 18 (Plan 08-02)
**Files:** .planning/phases/08-bmi-compliance-validation/bmi-tester-output.log

## Completion Criteria
1. bmi-tester bootstrap passes (4 tests)
2. bmi-tester Stage 1 passes (component name, var names, time functions)
3. bmi-tester Stage 2 passes (var type, units, itemsize, nbytes, location for all 12 vars)
4. bmi-tester Stage 3 passes (grid metadata + get_value for all 3 grids + 8 output vars)
5. 151 Fortran tests pass (no regression)
6. 38 Python pytest tests pass (no regression)
7. Standalone E2E script passes (no regression)
8. Expected non-implementations documented (get_value_ptr = BMI_FAILURE)

## Risk Mitigation
- **Singleton crash:** finalize() is non-destructive; re-init guard returns BMI_SUCCESS
- **tmpdir staging:** --root-dir bypasses file copying
- **MPI requirement:** mpirun --oversubscribe -np 1 wraps bmi-test
- **Unknown failures:** Iterative fix-and-rerun approach (no cap on iterations)

## Estimated Duration
~15-20 minutes (depends on number of fix iterations)
