---
phase: 06-babelizer-environment-skeleton
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - babel.toml
  - wrfhydro-bmi-snapshot.yml
autonomous: true
requirements: [ENV-01, ENV-02, ENV-03]

must_haves:
  truths:
    - "babelizer CLI is available and can be invoked from the command line"
    - "babel.toml exists at project root with correct naming chain matching our Fortran module/type"
    - "pymt_wrfhydro/ directory exists at project root with all auto-generated babelizer files"
    - "bmi_interoperability.f90 in the generated skeleton USEs the correct Fortran module name (bmiwrfhydrof) and references the correct type (bmi_wrf_hydro)"
  artifacts:
    - path: "babel.toml"
      provides: "Babelizer configuration with naming chain and runtime requirements"
      contains: "library = \"bmiwrfhydrof\""
    - path: "pymt_wrfhydro/pymt_wrfhydro/__init__.py"
      provides: "Python package init importing WrfHydroBmi"
    - path: "pymt_wrfhydro/setup.py"
      provides: "Build script for setuptools-based Fortran compilation"
    - path: "pymt_wrfhydro/pyproject.toml"
      provides: "Project metadata and build system declaration"
    - path: "pymt_wrfhydro/pymt_wrfhydro/lib/bmi_interoperability.f90"
      provides: "Auto-generated Fortran C interop layer wrapping all BMI functions"
      contains: "use bmiwrfhydrof"
  key_links:
    - from: "babel.toml [library.WrfHydroBmi] library field"
      to: "pymt_wrfhydro/pymt_wrfhydro/lib/bmi_interoperability.f90"
      via: "babelizer init code generation"
      pattern: "use bmiwrfhydrof"
    - from: "babel.toml [library.WrfHydroBmi] entry_point field"
      to: "pymt_wrfhydro/pymt_wrfhydro/lib/bmi_interoperability.f90"
      via: "babelizer init code generation"
      pattern: "type.*bmi_wrf_hydro"
    - from: "$CONDA_PREFIX/lib/libbmiwrfhydrof.so"
      to: "pymt_wrfhydro/setup.py"
      via: "pkg-config bmiwrfhydrof discovery"
      pattern: "pkg-config"
---

<objective>
Install the babelizer toolchain into the wrfhydro-bmi conda environment, write babel.toml with the verified naming chain, run `babelize init` to generate the complete pymt_wrfhydro package skeleton, and verify that all auto-generated files are correct.

Purpose: This is the critical bridge from Fortran shared library to Python package. The babelizer auto-generates the entire Fortran-C interop layer and Cython wrapper that replaced our hand-written C bindings (removed in Phase 5). Getting the naming chain right here ensures the generated code will link correctly in Phase 7.

Output: babel.toml at project root, pymt_wrfhydro/ directory with complete skeleton, conda env snapshot for rollback safety, dry-run build attempt documented for Phase 7.
</objective>

<execution_context>
@/home/mohansai/.claude/get-shit-done/workflows/execute-plan.md
@/home/mohansai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-babelizer-environment-skeleton/06-RESEARCH.md
@.planning/phases/06-babelizer-environment-skeleton/06-CONTEXT.md
@.planning/phases/05-library-hardening/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install babelizer toolchain into wrfhydro-bmi conda environment</name>
  <files>wrfhydro-bmi-snapshot.yml</files>
  <action>
Install the 6 required conda packages for the babelizer toolchain into the existing wrfhydro-bmi environment. Per user decision, install into the existing env (not a new one), snapshot first for rollback safety.

Steps:
1. Activate the conda environment:
   ```
   source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi
   ```

2. Snapshot the environment for rollback safety:
   ```
   conda env export > wrfhydro-bmi-snapshot-$(date +%Y%m%d).yml
   ```
   Save the snapshot file in the project root directory.

3. Optionally dry-run first to check for conflicts:
   ```
   conda install -c conda-forge --dry-run babelizer meson-python meson ninja cython python-build
   ```
   If the dry-run shows UnsatisfiableError or major downgrades, document and resolve before proceeding. If dependency conflicts arise, resolve them (update packages, adjust pins) rather than creating a separate env -- per user decision.

4. Install all 6 packages in one command:
   ```
   conda install -c conda-forge babelizer meson-python meson ninja cython python-build
   ```

5. Verify all 6 are installed and importable/callable:
   - `babelize --version` (should print version, confirms CLI available)
   - `python -c "import cython; print(cython.__version__)"` (should print version)
   - `meson --version` (should print version)
   - `ninja --version` (should print version)
   - `python -c "import build; print(build.__version__)"` (python-build)
   - `python -c "import mesonbuild; print('meson-python OK')"` or `pip show meson-python` (meson-python)

NOTE: Babelizer 0.3.9 from conda-forge is the target (not the develop branch). This version generates setuptools-based packages (setup.py), not meson-based (meson.build). The meson/ninja/meson-python packages are installed as preparation for Phase 7 if a build system switch is needed, per user requirements.
  </action>
  <verify>
    <automated>source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi && babelize --version && python -c "import cython; print('cython', cython.__version__)" && meson --version && ninja --version && python -c "import build; print('python-build', build.__version__)" && pip show meson-python | grep Version</automated>
    <manual>All 6 package versions print without error</manual>
  </verify>
  <done>
    - All 6 conda packages (babelizer, meson-python, meson, ninja, cython, python-build) installed in wrfhydro-bmi env
    - `babelize --version` returns a version string (0.3.9 expected)
    - Environment snapshot saved for rollback safety
    - No existing packages broken (gfortran, MPI, NetCDF, bmi-fortran all still available)
  </done>
</task>

<task type="auto">
  <name>Task 2: Write babel.toml, generate pymt_wrfhydro skeleton, and verify</name>
  <files>babel.toml, pymt_wrfhydro/</files>
  <action>
Write the babel.toml configuration file at the project root, run `babelize init` to generate the pymt_wrfhydro package skeleton, then verify all generated files and naming chain correctness.

Steps:

**Part A: Pre-flight naming chain verification**

Before writing babel.toml, verify the naming chain matches our actual artifacts:
```bash
# Module name in source (must match library field)
grep "^module bmiwrfhydrof" bmi_wrf_hydro/src/bmi_wrf_hydro.f90

# Type name in source (must match entry_point field)
grep "type.*extends.*bmi.*::.*bmi_wrf_hydro" bmi_wrf_hydro/src/bmi_wrf_hydro.f90

# Shared library name (must match lib{library}.so pattern)
ls $CONDA_PREFIX/lib/libbmiwrfhydrof.so

# .mod file (must match {library}.mod pattern)
ls $CONDA_PREFIX/include/bmiwrfhydrof.mod

# pkg-config discovery working
pkg-config --cflags --libs bmiwrfhydrof
```

**Part B: Write babel.toml**

Create `babel.toml` at the project root with these exact contents (locked per user decision):

```toml
[library.WrfHydroBmi]
language = "fortran"
library = "bmiwrfhydrof"
header = ""
entry_point = "bmi_wrf_hydro"

[build]
undef_macros = []
define_macros = []
libraries = []
library_dirs = []
include_dirs = []
extra_compile_args = []

[package]
name = "pymt_wrfhydro"
requirements = ["mpi4py", "netCDF4"]

[info]
github_username = "VT-Hydroinformatics"
package_author = "Mohan Sai Movva"
package_author_email = ""
package_license = "MIT"
summary = "PyMT plugin for the WRF-Hydro hydrological model"

[ci]
python_version = ["3.10"]
os = ["linux"]
```

Key naming chain (locked): `library = "bmiwrfhydrof"` (matches module name), `entry_point = "bmi_wrf_hydro"` (matches derived type name), `package.name = "pymt_wrfhydro"` (target Python package). The `[build]` section is empty because pkg-config handles library discovery -- per user decision, no manual library_dirs or include_dirs.

Python version: 3.10 (matches our conda env). Use Claude's discretion on package metadata but keep it appropriate for a research tool.

**Part C: Run babelize init**

Run from the project root directory so pymt_wrfhydro/ is generated at the correct level:
```bash
cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI
babelize init babel.toml
```

The command may prompt for git config (author, email). If it does, provide reasonable defaults.

If babelize init fails, capture the full error message and diagnose. Common issues:
- Missing git config: `git config --global user.name "..." && git config --global user.email "..."`
- Wrong CWD: must be project root
- babel.toml syntax error: check TOML formatting

**Part D: Verify generated files**

Check that all expected files exist:
```bash
# Directory exists
test -d pymt_wrfhydro && echo "PASS: pymt_wrfhydro/ directory" || echo "FAIL"

# Key files exist
test -f pymt_wrfhydro/setup.py && echo "PASS: setup.py" || echo "FAIL"
test -f pymt_wrfhydro/pyproject.toml && echo "PASS: pyproject.toml" || echo "FAIL"
test -f pymt_wrfhydro/pymt_wrfhydro/__init__.py && echo "PASS: __init__.py" || echo "FAIL"

# Find interop files (path may vary based on babelizer version)
find pymt_wrfhydro -name "bmi_interoperability.f90"
find pymt_wrfhydro -name "*.pyx"
find pymt_wrfhydro -name "bmi_interoperability.h"
```

NOTE: Babelizer 0.3.9 generates `setup.py` (not `meson.build`). This is expected. The success criteria should verify setup.py exists. If babelizer generates meson.build instead (newer version), that is also acceptable.

**Part E: Verify naming chain in generated code**

This is the most critical verification. The auto-generated bmi_interoperability.f90 must reference our exact module and type names:
```bash
INTEROP=$(find pymt_wrfhydro -name "bmi_interoperability.f90")
grep "use bmiwrfhydrof" "$INTEROP"          # Must find: use bmiwrfhydrof
grep "bmi_wrf_hydro" "$INTEROP"             # Must find: type (bmi_wrf_hydro)
```

If either grep fails, the naming chain is wrong and the skeleton will not link. Stop and diagnose.

**Part F: Quick dry-run build attempt**

Per user decision, attempt a build knowing it may fail. Document the outcome for Phase 7:
```bash
cd pymt_wrfhydro
pip install --no-build-isolation -e . 2>&1 | tail -50
```

Expected outcome: likely FAILS (this is Phase 7's job). Capture the exact error message and likely fix direction. Return to project root after.

**Part G: Document dry-run results**

If the build fails, create a brief note in the SUMMARY for Phase 7's planner. Include:
- Exact error message (first error line)
- Which file/step failed (compilation? linking? Cython?)
- Suggested fix direction (pin setuptools, add compiler flags, etc.)
  </action>
  <verify>
    <automated>source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi && cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI && test -d pymt_wrfhydro && test -f pymt_wrfhydro/pyproject.toml && test -f pymt_wrfhydro/pymt_wrfhydro/__init__.py && INTEROP=$(find pymt_wrfhydro -name "bmi_interoperability.f90") && test -n "$INTEROP" && grep -q "use bmiwrfhydrof" "$INTEROP" && grep -q "bmi_wrf_hydro" "$INTEROP" && echo "ALL CHECKS PASS"</automated>
    <manual>pymt_wrfhydro/ directory tree looks correct, bmi_interoperability.f90 references our module/type</manual>
  </verify>
  <done>
    - babel.toml exists at project root with correct naming chain (library=bmiwrfhydrof, entry_point=bmi_wrf_hydro, package.name=pymt_wrfhydro)
    - pymt_wrfhydro/ directory exists at project root with all auto-generated files
    - bmi_interoperability.f90 contains `use bmiwrfhydrof` and `type (bmi_wrf_hydro)` (correct naming chain)
    - .pyx Cython wrapper file exists in the skeleton
    - setup.py OR meson.build exists (depending on babelizer version)
    - pyproject.toml exists with package metadata
    - Dry-run build attempt results documented for Phase 7
  </done>
</task>

</tasks>

<verification>
Phase 6 is complete when ALL of the following are true:

1. **ENV-01**: All 6 conda packages installed and verified:
   - `babelize --version` prints version
   - `python -c "import cython"` works
   - `meson --version` prints version
   - `ninja --version` prints version
   - `python -c "import build"` works
   - `pip show meson-python` shows version

2. **ENV-02**: `babel.toml` at project root contains:
   - `library = "bmiwrfhydrof"` (matches Fortran module name)
   - `entry_point = "bmi_wrf_hydro"` (matches Fortran derived type)
   - `package.name = "pymt_wrfhydro"` (target Python package)
   - `requirements = ["mpi4py", "netCDF4"]` (runtime deps)

3. **ENV-03**: `pymt_wrfhydro/` directory contains:
   - `bmi_interoperability.f90` with `use bmiwrfhydrof` and `type (bmi_wrf_hydro)`
   - `.pyx` Cython wrapper file
   - `__init__.py` Python package init
   - `pyproject.toml` project metadata
   - `setup.py` (babelizer 0.3.9) OR `meson.build` (develop branch)

4. **No regressions**: Existing tools still work (gfortran, mpif90, pkg-config bmiwrfhydrof)
</verification>

<success_criteria>
- `babelize --version` returns 0.3.9 (or compatible version)
- `cat babel.toml` shows correct naming chain
- `find pymt_wrfhydro -name "bmi_interoperability.f90" -exec grep "use bmiwrfhydrof" {} \;` returns a match
- `find pymt_wrfhydro -name "*.pyx" | wc -l` returns >= 1
- `test -f pymt_wrfhydro/pyproject.toml` succeeds
- `pkg-config --libs bmiwrfhydrof` still returns correct flags (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/06-babelizer-environment-skeleton/06-01-SUMMARY.md`
</output>
