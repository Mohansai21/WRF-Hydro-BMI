---
phase: 07-package-build
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bmi_wrf_hydro/build.sh
  - pymt_wrfhydro/pymt_wrfhydro/__init__.py
autonomous: true
requirements: [BUILD-01, BUILD-02, BUILD-03]

must_haves:
  truths:
    - "libbmiwrfhydrof.so has no undefined hydro_stop_ symbol"
    - "pip install --no-build-isolation . completes without error inside pymt_wrfhydro/"
    - "from pymt_wrfhydro import WrfHydroBmi imports without error under mpirun"
    - "MPI is loaded with RTLD_GLOBAL before the Cython extension loads"
    - "Missing mpi4py raises ImportError with install instructions"
  artifacts:
    - path: "bmi_wrf_hydro/build.sh"
      provides: "hydro_stop_shim.f90 compilation and linking into .so"
      contains: "hydro_stop_shim"
    - path: "pymt_wrfhydro/pymt_wrfhydro/__init__.py"
      provides: "MPI bootstrap + version + info() + WrfHydroBmi import"
      contains: "RTLD_GLOBAL"
    - path: "$CONDA_PREFIX/lib/libbmiwrfhydrof.so"
      provides: "Shared library with hydro_stop_ resolved"
  key_links:
    - from: "pymt_wrfhydro/pymt_wrfhydro/__init__.py"
      to: "libbmiwrfhydrof.so"
      via: "sys.setdlopenflags(RTLD_GLOBAL) -> mpi4py import -> .bmi import triggers Cython .so -> dlopen libbmiwrfhydrof.so"
      pattern: "setdlopenflags.*RTLD_GLOBAL"
    - from: "bmi_wrf_hydro/build.sh"
      to: "$CONDA_PREFIX/lib/libbmiwrfhydrof.so"
      via: "build.sh --shared compiles hydro_stop_shim.o, links into .so, installs to conda prefix"
      pattern: "hydro_stop_shim"
---

<objective>
Fix the `hydro_stop_` undefined symbol in libbmiwrfhydrof.so, modify `__init__.py` for MPI bootstrap, build and install pymt_wrfhydro, and verify it imports cleanly from Python.

Purpose: Resolve the Phase 6 known blocker (hydro_stop_ undefined symbol), add MPI RTLD_GLOBAL preload to prevent segfaults, and get pymt_wrfhydro importable -- the foundation for all subsequent Python-side validation.

Output: Working `from pymt_wrfhydro import WrfHydroBmi` under mpirun, with MPI properly initialized.
</objective>

<execution_context>
@/home/mohansai/.claude/get-shit-done/workflows/execute-plan.md
@/home/mohansai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-package-build/07-RESEARCH.md
@.planning/phases/06-babelizer-environment-skeleton/06-01-SUMMARY.md
@bmi_wrf_hydro/build.sh
@pymt_wrfhydro/pymt_wrfhydro/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hydro_stop_ symbol in libbmiwrfhydrof.so and reinstall</name>
  <files>bmi_wrf_hydro/build.sh</files>
  <action>
The `hydro_stop_` undefined symbol occurs because `hydro_stop_shim.f90` (already in `bmi_wrf_hydro/src/`) was never compiled or linked into the shared library. The shim provides a bare external `hydro_stop_` subroutine that delegates to the module version, resolving the reference pulled in by `--whole-archive` from dead code in `module_reservoir_routing.F90`.

1. **Edit `bmi_wrf_hydro/build.sh`** in the `--shared` mode section:

   a. In the compile step (Step 2a, where IO files are recompiled with -fPIC), add compilation of hydro_stop_shim.f90:
   ```bash
   echo "    Compiling hydro_stop_shim.f90 with -fPIC..."
   ${FC} -c -fPIC -I${WRF_MODS} "${SRC_DIR}/hydro_stop_shim.f90" \
       -o "${BUILD_DIR}/hydro_stop_shim.o"
   echo "    -> build/hydro_stop_shim.o created"
   ```
   (Place this AFTER the existing IO file recompilation and BEFORE the gfortran -shared command.)

   b. In the link step (Step 2b, the `gfortran -shared` command), add `"${BUILD_DIR}/hydro_stop_shim.o"` to the object file list, alongside `bmi_wrf_hydro.o` and the two IO .o files.

2. **Run the rebuild**: `cd bmi_wrf_hydro && ./build.sh --shared`

   This will:
   - Compile bmi_wrf_hydro.f90, hydro_stop_shim.f90, and IO files with -fPIC
   - Link them all into libbmiwrfhydrof.so with --whole-archive on 22 WRF-Hydro libs
   - Auto-run 151-test regression (must all pass)
   - Auto-install .so + .mod files to $CONDA_PREFIX

3. **Verify the fix**: `nm -D $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep hydro_stop_`
   - Must show `T hydro_stop_` (defined, text section) -- NOT `U hydro_stop_` (undefined)
   - The module version `__module_hydro_stop_MOD_hydro_stop` should also still be `T` (defined)

Important: Activate conda env first: `source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi`
  </action>
  <verify>
    <automated>source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi && nm -D $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep "T hydro_stop_" | head -5</automated>
    <manual>Verify `T hydro_stop_` appears (not `U hydro_stop_`). Also confirm 151-test suite passed during build.</manual>
  </verify>
  <done>libbmiwrfhydrof.so has hydro_stop_ as a defined (T) symbol, 151-test Fortran suite passes against rebuilt .so, library installed to $CONDA_PREFIX/lib/</done>
</task>

<task type="auto">
  <name>Task 2: Modify __init__.py for MPI bootstrap, pip install, and verify import</name>
  <files>pymt_wrfhydro/pymt_wrfhydro/__init__.py</files>
  <action>
Two changes: (A) rewrite `__init__.py` for MPI bootstrap, and (B) pip install + verify import.

**A. Rewrite `pymt_wrfhydro/pymt_wrfhydro/__init__.py`:**

Replace the entire file with MPI bootstrap pattern from research (Pattern 1 in 07-RESEARCH.md):

```python
"""PyMT plugin for WRF-Hydro hydrological model."""
import sys
import ctypes

# MPI bootstrap: must happen BEFORE Cython extension loads libbmiwrfhydrof.so
# Open MPI 5.0.8 requires RTLD_GLOBAL for its plugin system to resolve symbols.
# Without this, loading libbmiwrfhydrof.so (which links libmpi) causes segfaults.
_old_dlopen_flags = sys.getdlopenflags()
sys.setdlopenflags(_old_dlopen_flags | ctypes.RTLD_GLOBAL)

try:
    from mpi4py import MPI  # noqa: F401
except ImportError:
    sys.setdlopenflags(_old_dlopen_flags)  # restore before raising
    raise ImportError(
        "pymt_wrfhydro requires mpi4py for MPI support.\n"
        "Install with: conda install -c conda-forge mpi4py\n"
        "or: pip install mpi4py"
    )

sys.setdlopenflags(_old_dlopen_flags)  # restore after MPI is loaded

# Version from package metadata (replaces deprecated pkg_resources)
from importlib.metadata import version as _get_version
__version__ = _get_version("pymt_wrfhydro")
__bmi_version__ = "2.0"

# NOW safe to import the Cython extension (triggers libbmiwrfhydrof.so load)
from .bmi import WrfHydroBmi

__all__ = ["WrfHydroBmi"]


def info():
    """Print debugging information about pymt_wrfhydro installation."""
    print(f"pymt_wrfhydro version: {__version__}")
    print(f"BMI version: {__bmi_version__}")
    print(f"Python: {sys.version}")
    try:
        from mpi4py import MPI as _MPI
        lib_ver = _MPI.Get_library_version()
        print(f"mpi4py: {lib_ver.split(chr(10))[0][:70]}...")
    except Exception:
        print("mpi4py: not available")
```

Key design points per CONTEXT.md locked decisions:
- Auto-handle MPI -- user does NOT need to manually import mpi4py first
- Hard error (ImportError) with clear install instructions if mpi4py missing
- Set RTLD_GLOBAL before Cython extension loads (prevents MPI segfault)
- Replace deprecated `pkg_resources` with `importlib.metadata.version`
- Expose `__version__`, `__bmi_version__`, and `info()` for debugging
- Do NOT call MPI_Finalize anywhere

**B. Build and install pymt_wrfhydro:**

```bash
cd pymt_wrfhydro
pip install --no-build-isolation -v .
```

Use full install (not editable) for the final validation per CONTEXT.md. The `-v` flag shows compiler output for diagnosing any issues.

**C. Verify import under mpirun:**

```bash
cd /tmp  # Move away from pymt_wrfhydro to ensure installed package is used
mpirun --oversubscribe -np 1 python -c "from pymt_wrfhydro import WrfHydroBmi; print('SUCCESS: WrfHydroBmi imported'); import pymt_wrfhydro; pymt_wrfhydro.info()"
```

Expected output should show:
- "SUCCESS: WrfHydroBmi imported"
- pymt_wrfhydro version, BMI version 2.0, Python version, mpi4py info

If import fails, check error message. Common issues:
- `undefined symbol: hydro_stop_` -- Task 1 fix didn't work, re-examine nm output
- Segfault -- RTLD_GLOBAL not set before MPI load, check __init__.py order
- `ModuleNotFoundError: pymt_wrfhydro` -- pip install failed, check pip output
  </action>
  <verify>
    <automated>source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi && mpirun --oversubscribe -np 1 python -c "from pymt_wrfhydro import WrfHydroBmi; print('SUCCESS: WrfHydroBmi imported'); import pymt_wrfhydro; pymt_wrfhydro.info()"</automated>
    <manual>Verify "SUCCESS: WrfHydroBmi imported" appears, version info prints, no segfault, no undefined symbol errors.</manual>
  </verify>
  <done>`pip install --no-build-isolation .` completes successfully, `from pymt_wrfhydro import WrfHydroBmi` imports without error under mpirun, MPI bootstrap works (RTLD_GLOBAL set, mpi4py loaded), __version__ and info() functional</done>
</task>

</tasks>

<verification>
1. `nm -D $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep "T hydro_stop_"` -- shows defined symbol (not U)
2. `pip show pymt_wrfhydro` -- shows installed package with version
3. `mpirun --oversubscribe -np 1 python -c "from pymt_wrfhydro import WrfHydroBmi; print('OK')"` -- prints OK, no errors
4. `mpirun --oversubscribe -np 1 python -c "import pymt_wrfhydro; pymt_wrfhydro.info()"` -- prints version, BMI version, Python, mpi4py info
</verification>

<success_criteria>
- libbmiwrfhydrof.so rebuilt with hydro_stop_ resolved (T, not U)
- 151-test Fortran regression suite passes against rebuilt .so
- pip install --no-build-isolation . completes in pymt_wrfhydro/
- from pymt_wrfhydro import WrfHydroBmi works under mpirun without segfault
- __version__, __bmi_version__, info() all functional
- No pkg_resources deprecation warnings on import
</success_criteria>

<output>
After completion, create `.planning/phases/07-package-build/07-01-SUMMARY.md`
</output>
