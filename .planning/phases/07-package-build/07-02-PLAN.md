---
phase: 07-package-build
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - pymt_wrfhydro/tests/test_bmi_wrfhydro.py
  - pymt_wrfhydro/tests/test_e2e_standalone.py
autonomous: true
requirements: [BUILD-04]

must_haves:
  truths:
    - "Python initialize/update/finalize cycle completes without error using Croton NY data"
    - "All 8 output variables return physically plausible values from Python"
    - "Streamflow values from Python match Fortran 151-test reference output within tolerance"
    - "Both pytest and standalone test scripts succeed under mpirun"
  artifacts:
    - path: "pymt_wrfhydro/tests/test_bmi_wrfhydro.py"
      provides: "pytest suite with reference value comparison for all 8 output variables"
      contains: "channel_water__volume_flow_rate"
    - path: "pymt_wrfhydro/tests/test_e2e_standalone.py"
      provides: "Standalone Python script for quick manual E2E validation"
      contains: "initialize"
  key_links:
    - from: "pymt_wrfhydro/tests/test_bmi_wrfhydro.py"
      to: "pymt_wrfhydro (installed package)"
      via: "from pymt_wrfhydro import WrfHydroBmi"
      pattern: "from pymt_wrfhydro import WrfHydroBmi"
    - from: "pymt_wrfhydro/tests/test_bmi_wrfhydro.py"
      to: "WRF_Hydro_Run_Local/run/"
      via: "BMI config file with wrfhydro_run_dir absolute path"
      pattern: "wrfhydro_run_dir"
---

<objective>
Write and run end-to-end validation tests that exercise the full BMI initialize/update/finalize cycle from Python against Croton NY data, comparing all 8 output variable values against Fortran 151-test reference output.

Purpose: Prove that the babelized pymt_wrfhydro package produces correct results -- not just that it imports, but that the full Fortran model actually runs through the Python-Cython-Fortran bridge and produces scientifically valid output.

Output: Two test files (pytest + standalone) that pass under mpirun, validating all 8 output variables against Fortran reference values.
</objective>

<execution_context>
@/home/mohansai/.claude/get-shit-done/workflows/execute-plan.md
@/home/mohansai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-package-build/07-RESEARCH.md
@.planning/phases/07-package-build/07-01-SUMMARY.md
@bmi_wrf_hydro/tests/bmi_wrf_hydro_test.f90
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Fortran reference values and write pytest + standalone E2E tests</name>
  <files>pymt_wrfhydro/tests/test_bmi_wrfhydro.py, pymt_wrfhydro/tests/test_e2e_standalone.py</files>
  <action>
**Step 1: Extract reference values from Fortran 151-test suite.**

Run the Fortran 151-test suite and capture the output values for all 8 output variables after 6 time steps (6 hours). These become the reference for Python comparison.

```bash
cd bmi_wrf_hydro
mpirun --oversubscribe -np 1 ./build/bmi_wrf_hydro_test 2>&1 | tee /tmp/fortran_ref_output.txt
```

From the output, extract the values printed by the test suite for these 8 CSDMS Standard Name variables:
- `channel_water__volume_flow_rate` (QLINK1, streamflow, m3/s)
- `land_surface_water__depth` (sfcheadrt, m)
- `soil_water__volume_fraction` (SOIL_M, dimensionless)
- `snowpack__liquid-equivalent_depth` (SNEQV, m)
- `land_surface_water__evaporation_volume_flux` (ACCET, mm)
- `land_surface_air__temperature` (T2, K)
- `atmosphere_water__precipitation_leq-volume_flux` (RAINRATE, mm/s)
- `soil_water__domain_time_integral_of_baseflow_volume_flux` (UGDRNOFF, mm)

For each variable, capture: min, max, and a few spot-check values. Store as a Python dict in the test file.

**Step 2: Create `pymt_wrfhydro/tests/` directory if it doesn't exist.**

```bash
mkdir -p pymt_wrfhydro/tests
```

**Step 3: Write `pymt_wrfhydro/tests/test_bmi_wrfhydro.py` (pytest format).**

Structure:
```python
"""
Pytest suite for pymt_wrfhydro BMI package.
Validates full IRF cycle with Croton NY data against Fortran 151-test reference.
Run with: mpirun --oversubscribe -np 1 python -m pytest tests/test_bmi_wrfhydro.py -v
"""
import os
import tempfile
import pytest
import numpy as np
from pymt_wrfhydro import WrfHydroBmi

# Fortran 151-test reference values (extracted from test output after 6 hours)
FORTRAN_REFERENCE = {
    # Populated from Step 1 extraction
}

# Tolerance: REAL(4) -> double has ~7 significant digits
RTOL = 1e-5
ATOL = 1e-6
```

Tests (all sharing a single session-scoped fixture due to WRF-Hydro singleton constraint):

a. **`conftest.py`** with session-scoped `bmi_model` fixture:
   - Creates BMI config file with absolute path to `WRF_Hydro_Run_Local/run/`
   - Calls `initialize()`, yields model, calls `finalize()` in teardown
   - Compute absolute path: `os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "..", "WRF_Hydro_Run_Local", "run"))`
   - Use `os.chdir()` to the run directory before init (Fortran character(len=80) path limits)

b. **`test_initialize`**: Verify model.initialize() succeeds (done in fixture, just check model is not None)

c. **`test_update_6_steps`**: Call `model.update()` 6 times, verify no exceptions

d. **`test_component_name`**: Verify `get_component_name()` returns "WRF-Hydro v5.4.0 (NCAR)"

e. **`test_output_var_count`**: Verify `get_output_item_count()` returns 8

f. **`test_streamflow_values`**: Get `channel_water__volume_flow_rate`, compare max/min against reference with `np.allclose`

g. **`test_soil_moisture_values`**: Get `soil_water__volume_fraction`, compare against reference

h. **`test_surface_head_values`**: Get `land_surface_water__depth`, compare against reference

i. **`test_temperature_values`**: Get `land_surface_air__temperature`, compare values are in physically plausible range (200-350 K) and match reference

j. **`test_all_8_output_variables`**: Loop over all 8 output vars, call get_value for each, verify non-empty arrays with plausible ranges

IMPORTANT: The fixture must call `os.chdir()` back to the original directory in teardown (after finalize). WRF-Hydro writes output files in the working directory.

Floating-point tolerance per Claude's discretion (from CONTEXT.md): Use `rtol=1e-5, atol=1e-6` for `np.allclose()`. The data path is REAL(4) -> double(8) -> c_double -> numpy.float64, preserving ~7 significant digits.

**Step 4: Write `pymt_wrfhydro/tests/test_e2e_standalone.py` (standalone script).**

A self-contained script that:
1. Creates BMI config file with absolute path
2. Instantiates WrfHydroBmi
3. Calls initialize() / update() x6 / finalize()
4. Prints all 8 output variable summaries (min, max, mean, shape)
5. Prints SUCCESS/FAIL at the end
6. Exit code 0 on success, 1 on failure

Run with: `mpirun --oversubscribe -np 1 python tests/test_e2e_standalone.py`

Both test formats are required per CONTEXT.md locked decision.

**Step 5: Run both test suites.**

```bash
# pytest format (from pymt_wrfhydro/ directory)
cd pymt_wrfhydro
mpirun --oversubscribe -np 1 python -m pytest tests/test_bmi_wrfhydro.py -v

# standalone format
mpirun --oversubscribe -np 1 python tests/test_e2e_standalone.py
```

Both must pass. If they fail, diagnose and fix. Common issues:
- Working directory: WRF-Hydro writes output files; must os.chdir to run directory
- Path length: Use shortest absolute path possible (Fortran 80-char limit)
- Reference values: If extracted values don't match, re-run Fortran test and re-extract
  </action>
  <verify>
    <automated>source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi && cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/pymt_wrfhydro && mpirun --oversubscribe -np 1 python -m pytest tests/test_bmi_wrfhydro.py -v 2>&1 | tail -20</automated>
    <manual>Verify all pytest tests pass. Run standalone script separately: `cd pymt_wrfhydro && mpirun --oversubscribe -np 1 python tests/test_e2e_standalone.py` and verify SUCCESS output.</manual>
  </verify>
  <done>Both pytest and standalone tests pass under mpirun. All 8 output variables validated against Fortran reference values. Initialize/update/finalize cycle works end-to-end from Python with Croton NY data.</done>
</task>

</tasks>

<verification>
1. `cd pymt_wrfhydro && mpirun --oversubscribe -np 1 python -m pytest tests/test_bmi_wrfhydro.py -v` -- all tests pass
2. `cd pymt_wrfhydro && mpirun --oversubscribe -np 1 python tests/test_e2e_standalone.py` -- prints SUCCESS, exit code 0
3. Streamflow max value matches Fortran reference within rtol=1e-5
4. All 8 output variables return non-empty arrays with physically plausible values
</verification>

<success_criteria>
- pytest suite passes with all tests green under mpirun
- Standalone E2E script completes with SUCCESS output
- All 8 output variables validated against Fortran 151-test reference values
- Floating-point comparison uses np.allclose with rtol=1e-5, atol=1e-6
- Reference values stored as dict in test file (not computed on the fly)
- Tests work from pymt_wrfhydro/ directory using absolute paths to Croton NY data
</success_criteria>

<output>
After completion, create `.planning/phases/07-package-build/07-02-SUMMARY.md`
</output>
