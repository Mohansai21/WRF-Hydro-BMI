---
phase: 05-library-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bmi_wrf_hydro/src/bmi_wrf_hydro_c.f90
  - bmi_wrf_hydro/tests/test_bmi_python.py
  - bmi_wrf_hydro/tests/conftest.py
  - bmi_wrf_hydro/build.sh
  - bmi_wrf_hydro/CMakeLists.txt
autonomous: true
requirements:
  - LIB-01
  - LIB-02
  - LIB-03
  - LIB-04

must_haves:
  truths:
    - "libbmiwrfhydrof.so contains zero C binding symbols (nm -D shows no ' T bmi_' entries)"
    - "151-test Fortran suite passes against rebuilt .so in both static and shared linking modes"
    - "build.sh --shared auto-installs .so + .mod files to $CONDA_PREFIX"
    - "Both bmiwrfhydrof.mod and wrfhydro_bmi_state_mod.mod are present in $CONDA_PREFIX/include/"
    - "pkg-config --cflags --libs bmiwrfhydrof returns correct flags pointing to rebuilt library"
    - "bmi_wrf_hydro_c.f90 no longer exists in the repo"
  artifacts:
    - path: "bmi_wrf_hydro/build.sh"
      provides: "Build script without C binding compilation, with auto-install in --shared mode"
      contains: "Installing to.*CONDA"
    - path: "bmi_wrf_hydro/CMakeLists.txt"
      provides: "CMake build without C binding source or install rules"
    - path: "bmi_wrf_hydro/build/libbmiwrfhydrof.so"
      provides: "Rebuilt shared library without C binding symbols"
  key_links:
    - from: "bmi_wrf_hydro/build.sh"
      to: "bmi_wrf_hydro/build/libbmiwrfhydrof.so"
      via: "gfortran -shared without bmi_wrf_hydro_c.o"
      pattern: "gfortran -shared.*bmi_wrf_hydro\\.o.*module_NoahMP"
    - from: "bmi_wrf_hydro/build.sh --shared"
      to: "$CONDA_PREFIX/lib/libbmiwrfhydrof.so"
      via: "auto-install step copying .so + .mod + creating symlinks"
      pattern: "cp.*libbmiwrfhydrof\\.so.*CONDA"
---

<objective>
Remove the C binding layer from the shared library build, delete obsolete files, rebuild libbmiwrfhydrof.so, and verify all babelizer prerequisites are met.

Purpose: The babelizer auto-generates its own C interop layer (bmi_interoperability.f90). Our hand-written C bindings in bmi_wrf_hydro_c.f90 export 10 `bmi_*` symbols that would cause duplicate symbol errors during babelization. This plan surgically removes them and verifies the library is clean.

Output: Rebuilt libbmiwrfhydrof.so (no C symbols), updated build systems, auto-install in build.sh --shared, all tests passing in both modes.
</objective>

<execution_context>
@/home/mohansai/.claude/get-shit-done/workflows/execute-plan.md
@/home/mohansai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-library-hardening/05-RESEARCH.md
@.planning/phases/05-library-hardening/05-CONTEXT.md
@bmi_wrf_hydro/build.sh
@bmi_wrf_hydro/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete C binding files and update both build systems</name>
  <files>
    bmi_wrf_hydro/src/bmi_wrf_hydro_c.f90
    bmi_wrf_hydro/tests/test_bmi_python.py
    bmi_wrf_hydro/tests/conftest.py
    bmi_wrf_hydro/build.sh
    bmi_wrf_hydro/CMakeLists.txt
  </files>
  <action>
    **Step 1: Delete obsolete source files**
    - `rm bmi_wrf_hydro/src/bmi_wrf_hydro_c.f90` (C binding layer, 335 lines)
    - `rm bmi_wrf_hydro/tests/test_bmi_python.py` (Python ctypes test, 312 lines)
    - `rm bmi_wrf_hydro/tests/conftest.py` (Python ctypes fixtures, 181 lines)
    - NOTE: The CONTEXT.md mentions `test_bmi_ctypes.py` but the actual file name is `test_bmi_python.py` (from Phase 3 Plan 2). Delete the actual file.

    **Step 2: Clean stale build artifacts**
    - `rm -f bmi_wrf_hydro/build/bmi_wrf_hydro_c.o` (stale compiled object)
    - `rm -f bmi_wrf_hydro/build/bmi_wrf_hydro_c_mod.mod` (stale module file)
    - `rm -f $CONDA_PREFIX/include/bmi_wrf_hydro_c_mod.mod` (stale installed module file)

    **Step 3: Update build.sh — remove C binding compilation (Step 1b block)**
    Delete the entire Step 1b block (lines ~148-154) that compiles bmi_wrf_hydro_c.f90:
    ```
    echo "=== Step 1b: Compile src/bmi_wrf_hydro_c.f90 (C binding layer) ==="
    ${FC} ${FFLAGS} ${EXTRA_FFLAGS} \
      -ffree-form -ffree-line-length-none -fconvert=big-endian -frecord-marker=4 \
      -fallow-argument-mismatch \
      ${INCLUDES} ${MOD_OUT} \
      "${SRC_DIR}/bmi_wrf_hydro_c.f90" -o "${BUILD_DIR}/bmi_wrf_hydro_c.o"
    echo "    -> build/bmi_wrf_hydro_c.o created"
    ```

    **Step 4: Update build.sh — remove bmi_wrf_hydro_c.o from shared library link line**
    In the `gfortran -shared` command (~line 197), remove the line:
    `"${BUILD_DIR}/bmi_wrf_hydro_c.o" \`
    Keep bmi_wrf_hydro.o and all other .o files.

    **Step 5: Update build.sh — remove bmi_wrf_hydro_c.o from static link_executable()**
    In the `link_executable()` function (~line 219), remove the line:
    `"${BUILD_DIR}/bmi_wrf_hydro_c.o" \`
    Keep bmi_wrf_hydro.o and the ${OBJ_FILE} parameter.

    **Step 6: Update build.sh — add auto-install to --shared mode**
    After the test execution block in --shared mode (after tests pass), add an install block:
    - Copy libbmiwrfhydrof.so to $CONDA_PREFIX/lib/libbmiwrfhydrof.so.1.0.0
    - Create symlinks: .so.1 -> .so.1.0.0, .so -> .so.1
    - Copy bmiwrfhydrof.mod and wrfhydro_bmi_state_mod.mod to $CONDA_PREFIX/include/
    - Print install confirmation
    Use `$CONDA_PREFIX` (not hardcoded path) for portability. Verify `$CONDA_PREFIX` is set before installing.

    **Step 7: Update CMakeLists.txt — remove C binding source from add_library()**
    Remove the line `src/bmi_wrf_hydro_c.f90` from the `add_library(${bmi_name} SHARED ...)` call (~line 276).

    **Step 8: Update CMakeLists.txt — remove C binding .mod install rule**
    Delete the entire install block for bmi_wrf_hydro_c_mod.mod (~lines 394-398):
    ```cmake
    # Install the C binding module .mod file
    install(
      FILES ${CMAKE_Fortran_MODULE_DIRECTORY}/bmi_wrf_hydro_c_mod.mod
      DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
    )
    ```
  </action>
  <verify>
    <automated>cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI && test ! -f bmi_wrf_hydro/src/bmi_wrf_hydro_c.f90 && test ! -f bmi_wrf_hydro/tests/test_bmi_python.py && test ! -f bmi_wrf_hydro/tests/conftest.py && echo "PASS: All C binding files deleted"</automated>
    <manual>Verify build.sh no longer contains "bmi_wrf_hydro_c" anywhere except comments. Verify CMakeLists.txt no longer references bmi_wrf_hydro_c.</manual>
  </verify>
  <done>
    - bmi_wrf_hydro_c.f90, test_bmi_python.py, conftest.py are deleted from the repo
    - Stale .o and .mod artifacts removed from build/ and $CONDA_PREFIX/include/
    - build.sh compiles only bmi_wrf_hydro.f90 + hydro_stop_shim.f90 (no C binding)
    - build.sh --shared includes auto-install to $CONDA_PREFIX
    - CMakeLists.txt no longer references C binding source or module
  </done>
</task>

<task type="auto">
  <name>Task 2: Rebuild, regression test in both modes, and run composite readiness check</name>
  <files>
    bmi_wrf_hydro/build/libbmiwrfhydrof.so
  </files>
  <action>
    IMPORTANT: Must activate conda env first: `source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi`

    **Step 1: Clean build artifacts**
    Run `cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/bmi_wrf_hydro && ./build.sh clean` to remove all stale objects.

    **Step 2: Rebuild and test in STATIC mode (default)**
    Run `cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/bmi_wrf_hydro && ./build.sh` (default = static linking).
    Then run both test suites from bmi_wrf_hydro/ directory:
    - `mpirun --oversubscribe -np 1 ./build/bmi_minimal_test` (smoke test, ~30s)
    - `mpirun --oversubscribe -np 1 ./build/bmi_wrf_hydro_test` (full 151-test suite, ~2-3min)
    Both must produce 0 failures. If any test fails, STOP — do not proceed.

    **Step 3: Clean and rebuild in SHARED mode**
    Run `cd /mnt/c/Users/mohansai/Desktop/Projects/VS_Code/WRF-Hydro-BMI/bmi_wrf_hydro && ./build.sh clean && ./build.sh --shared`
    The --shared mode auto-runs tests and (with Task 1's changes) auto-installs to $CONDA_PREFIX.
    All tests must pass. If any fails, STOP.

    **Step 4: Verify no conflicting C symbols (HARD BLOCKER)**
    Run: `nm -D bmi_wrf_hydro/build/libbmiwrfhydrof.so | grep " T bmi_"`
    Run: `nm -D $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep " T bmi_"`
    Both must return NOTHING (exit code 1 from grep = no match = success).
    If ANY `bmi_*` C symbol is found, this is a HARD BLOCKER — investigate and fix before proceeding.

    Verify Fortran module symbols are still present:
    Run: `nm -D $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep "__bmiwrfhydrof_MOD_" | head -5`
    Should show mangled Fortran symbols like `__bmiwrfhydrof_MOD_wrfhydro_initialize`.

    **Step 5: Composite babelizer readiness check (Phase 5 exit gate)**
    Run all 4 checks against the INSTALLED library:
    1. `nm -D $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep " T bmi_"` — must return nothing
    2. `ls $CONDA_PREFIX/include/bmiwrfhydrof.mod $CONDA_PREFIX/include/wrfhydro_bmi_state_mod.mod` — both must exist
    3. `pkg-config --cflags --libs bmiwrfhydrof` — must contain `-lbmiwrfhydrof` and `-I...include`
    4. `ldd $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep "not found"` — must return nothing

    All 4 checks must pass. Print a summary: "Babelizer Readiness: 4/4 PASS" or identify which failed.

    **Step 6: Verify stale C binding module removed**
    Run: `ls $CONDA_PREFIX/include/bmi_wrf_hydro_c_mod.mod 2>/dev/null` — must NOT exist.
  </action>
  <verify>
    <automated>source ~/miniconda3/etc/profile.d/conda.sh && conda activate wrfhydro-bmi && nm -D $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep -c " T bmi_" && echo "FAIL: C symbols still present" || echo "PASS: No C binding symbols" && test -f $CONDA_PREFIX/include/bmiwrfhydrof.mod && test -f $CONDA_PREFIX/include/wrfhydro_bmi_state_mod.mod && echo "PASS: .mod files present" && pkg-config --cflags --libs bmiwrfhydrof | grep -q lbmiwrfhydrof && echo "PASS: pkg-config correct"</automated>
  </verify>
  <done>
    - Static mode: 151-test suite + minimal test pass with zero failures
    - Shared mode: all tests pass when linked against rebuilt .so
    - nm -D shows zero `bmi_*` C symbols in both build-dir and installed .so
    - Fortran module symbols (__bmiwrfhydrof_MOD_*) still present
    - Both .mod files present in $CONDA_PREFIX/include/
    - pkg-config returns correct flags (-lbmiwrfhydrof, -I...include)
    - ldd shows no missing dependencies
    - Stale bmi_wrf_hydro_c_mod.mod removed from $CONDA_PREFIX/include/
    - Composite readiness: 4/4 PASS
  </done>
</task>

</tasks>

<verification>
1. `nm -D $CONDA_PREFIX/lib/libbmiwrfhydrof.so | grep " T bmi_"` returns nothing (LIB-01)
2. `ls $CONDA_PREFIX/include/bmiwrfhydrof.mod $CONDA_PREFIX/include/wrfhydro_bmi_state_mod.mod` shows both files (LIB-02)
3. `pkg-config --cflags --libs bmiwrfhydrof` returns `-lbmiwrfhydrof` and `-I...include` (LIB-03)
4. 151-test suite passes in both static and shared linking modes (LIB-04)
5. `bmi_wrf_hydro_c.f90` does not exist in the source tree
6. `bmi_wrf_hydro_c_mod.mod` does not exist in $CONDA_PREFIX/include/
</verification>

<success_criteria>
- All 4 babelizer readiness checks pass (nm, .mod, pkg-config, ldd)
- 151-test Fortran suite passes in BOTH static and shared modes
- No C binding files remain in the source tree
- build.sh --shared auto-installs to $CONDA_PREFIX
</success_criteria>

<output>
After completion, create `.planning/phases/05-library-hardening/05-01-SUMMARY.md`
</output>
