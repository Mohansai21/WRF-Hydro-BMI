---
phase: 02-shared-library-install
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bmi_wrf_hydro/build.sh
autonomous: true
requirements: [BUILD-03]

must_haves:
  truths:
    - "`./build.sh --shared full` produces `libbmiwrfhydrof.so` in `bmi_wrf_hydro/build/`"
    - "`--shared` auto-implies `--fpic` (uses build_fpic/ libraries without needing separate --fpic flag)"
    - "151-test BMI suite passes when linked against the shared library instead of static objects"
    - "`./build.sh --shared clean` removes the .so along with other build artifacts"
  artifacts:
    - path: "bmi_wrf_hydro/build.sh"
      provides: "--shared flag for building libbmiwrfhydrof.so and linking tests against it"
      contains: "--shared"
    - path: "bmi_wrf_hydro/build/libbmiwrfhydrof.so"
      provides: "Shared library containing BMI wrapper + all WRF-Hydro symbols"
  key_links:
    - from: "bmi_wrf_hydro/build.sh (--shared)"
      to: "wrf_hydro_nwm_public/build_fpic/lib/*.a"
      via: "-shared -Wl,--whole-archive linking"
      pattern: "--whole-archive.*--no-whole-archive"
    - from: "bmi_wrf_hydro/build/bmi_wrf_hydro_test"
      to: "bmi_wrf_hydro/build/libbmiwrfhydrof.so"
      via: "-L./build -lbmiwrfhydrof with rpath"
      pattern: "-Wl,-rpath"
---

<objective>
Add `--shared` flag to `build.sh` that builds `libbmiwrfhydrof.so` from the fPIC WRF-Hydro libraries and links the 151-test suite against it for regression verification.

Purpose: Provide a fast dev iteration path for building and testing the shared library without CMake overhead. This is the developer's primary build tool during Phase 3+ work.

Output: Updated `build.sh` with `--shared` support, producing a verified `libbmiwrfhydrof.so` in `bmi_wrf_hydro/build/`.
</objective>

<execution_context>
@/home/mohansai/.claude/get-shit-done/workflows/execute-plan.md
@/home/mohansai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fpic-foundation/01-01-SUMMARY.md
@bmi_wrf_hydro/build.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --shared flag to build.sh producing libbmiwrfhydrof.so</name>
  <files>bmi_wrf_hydro/build.sh</files>
  <action>
Update `bmi_wrf_hydro/build.sh` to support a `--shared` flag. Key changes:

1. **Parse `--shared` flag** alongside existing `--fpic` flag in the argument loop. When `--shared` is set, automatically set `USE_FPIC="true"` (shared implies fPIC per CONTEXT decision).

2. **Add shared library build step** (new Step 2 before test compilation). When `--shared` is active:
   - Compile `src/bmi_wrf_hydro.f90` with `-fPIC` flag added to FFLAGS (the source itself needs -fPIC even though the WRF-Hydro .a libs already have it).
   - Link into `build/libbmiwrfhydrof.so` using `gfortran -shared` (NOT mpif90 — gfortran passes linker flags correctly). The link command must include:
     - `build/bmi_wrf_hydro.o` (the BMI wrapper)
     - `${WRF_OBJ}/module_NoahMP_hrldas_driver.F.o` and `${WRF_OBJ}/module_hrldas_netcdf_io.F.o` (the two extra .o files)
     - `-Wl,--whole-archive ${ALL_WRF_STATIC_LIBS_FULL_PATHS} -Wl,--no-whole-archive` (force all symbols from the 22 static libs into the .so — needed because shared libs must resolve all symbols)
     - `-L${CONDA_P}/lib -lbmif` (BMI Fortran spec)
     - `-lnetcdff -lnetcdf` (NetCDF)
     - MPI libs via: `$(mpif90 --showme:link)` to extract MPI linker flags without using mpif90 as the driver
   - Construct `ALL_WRF_STATIC_LIBS_FULL_PATHS` by expanding each library name from WRF_LIBS_SINGLE into full paths like `${WRF_LIB}/libhydro_driver.a` (--whole-archive needs full paths, not -l flags).

3. **Modify test linking** when `--shared` is active. Instead of the current `link_executable` function that links against static objects directly, create a `link_executable_shared` function that:
   - Links test .o against `-L${BUILD_DIR} -lbmiwrfhydrof` (the shared library)
   - Adds `-Wl,-rpath,${BUILD_DIR}` so the test finds the .so at runtime without LD_LIBRARY_PATH
   - Still uses `mpif90` as the link driver (test executables need MPI for the test program's MPI_Init/Finalize)
   - Does NOT include the WRF-Hydro static libs or extra .o files (those are inside the .so now)

4. **Auto-run 151-test suite** when `--shared` is active. After building and linking, automatically run:
   ```
   cd ${BMI_DIR}/../WRF_Hydro_Run_Local/run && mpirun --oversubscribe -np 1 ${BUILD_DIR}/bmi_wrf_hydro_test
   ```
   Check exit code. Print pass/fail summary.

5. **Update clean target** to also remove `libbmiwrfhydrof.so` from build/.

6. **Update usage comment** at top of file to document the new flag combinations:
   - `./build.sh --shared` — Build .so + all tests linked against .so + run tests
   - `./build.sh --shared full` — Same but only full test
   - `./build.sh --shared minimal` — Build .so + minimal test linked against .so + run minimal test

Important implementation notes:
- Use `gfortran -shared` for creating the .so, NOT `mpif90 -shared`. The mpif90 wrapper can strip linker flags. Extract MPI flags via `mpif90 --showme:link` and pass them directly to gfortran.
- Use `--whole-archive` NOT `--start-group/--end-group`. For shared library creation, --whole-archive ensures ALL symbols from static libs are included (not just referenced ones), which is critical since downstream users of the .so may need any symbol.
- The -fPIC flag must be added to FFLAGS when compiling bmi_wrf_hydro.f90 in --shared mode (the wrapper source itself needs PIC, not just the WRF-Hydro libs).
  </action>
  <verify>
Run from the bmi_wrf_hydro/ directory:

1. `./build.sh --shared full` — must complete without errors, producing:
   - `build/libbmiwrfhydrof.so` (shared library)
   - `build/bmi_wrf_hydro_test` (linked against .so)
2. `ldd build/libbmiwrfhydrof.so` — no "not found" entries
3. `nm -D build/libbmiwrfhydrof.so | grep -i bmiwrfhydrof` — BMI symbols exported
4. The auto-run test suite reports 151/151 pass
5. `./build.sh --shared clean` — removes the .so and test executables
6. `./build.sh full` (without --shared) — still works as before (backward compatibility)
  </verify>
  <done>
`./build.sh --shared full` produces `libbmiwrfhydrof.so` with no unresolved symbols, links the 151-test suite against it, auto-runs the tests with all 151 passing, and backward compatibility with non-shared builds is preserved.
  </done>
</task>

</tasks>

<verification>
1. `ls -la bmi_wrf_hydro/build/libbmiwrfhydrof.so` — shared library exists
2. `ldd bmi_wrf_hydro/build/libbmiwrfhydrof.so | grep "not found"` — returns empty (no missing deps)
3. `nm -D bmi_wrf_hydro/build/libbmiwrfhydrof.so | grep -ci bmi` — returns non-zero count (BMI symbols exported)
4. 151/151 test pass when linked against the .so
5. `./build.sh full` (no --shared) still works — backward compatibility
</verification>

<success_criteria>
- `libbmiwrfhydrof.so` built successfully with zero unresolved symbols
- 151-test BMI suite passes when linked against the shared library
- `--shared` flag auto-implies `--fpic`
- Backward compatibility with existing build modes preserved
</success_criteria>

<output>
After completion, create `.planning/phases/02-shared-library-install/02-01-SUMMARY.md`
</output>
