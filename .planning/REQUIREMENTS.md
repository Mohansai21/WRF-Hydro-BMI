# Requirements: WRF-Hydro BMI Shared Library

**Defined:** 2026-02-23
**Core Value:** WRF-Hydro must be callable from Python through a shared library — gateway to Phase 2 (babelizer) and coupled simulations

## v1 Requirements

Requirements for the shared library milestone. Each maps to roadmap phases.

### Build Infrastructure

- [ ] **BUILD-01**: WRF-Hydro 22 static libraries recompiled with `-fPIC` (`CMAKE_POSITION_INDEPENDENT_CODE=ON`) so they can be linked into a shared library
- [ ] **BUILD-02**: `libwrfhydro_bmi.so` builds successfully via CMake, linking all 22 WRF-Hydro static libs + BMI + NetCDF + MPI with no unresolved symbols
- [ ] **BUILD-03**: `build.sh` updated with shared library target (`-shared` flag) for fast dev iteration builds
- [ ] **BUILD-04**: `cmake --install` places `libwrfhydro_bmi.so`, `.mod` files, and `.pc` file into `$CONDA_PREFIX/{lib,include,lib/pkgconfig}`
- [ ] **BUILD-05**: pkg-config `.pc` file generated by CMake (template from `bmi-example-fortran`) enabling babelizer discovery via `pkg-config bmiwrfhydrof`

### C Binding Layer

- [ ] **CBIND-01**: `bmi_interop.f90` implements ISO_C_BINDING `bind(C)` wrappers for all 41 BMI functions, each accepting/returning C-compatible types
- [ ] **CBIND-02**: `register_bmi()` C-callable entry point allocates `bmi_wrf_hydro` instance, wraps in polymorphism-hiding box type, returns opaque `c_ptr` handle
- [ ] **CBIND-03**: String conversion helper functions (`c_to_f_string`, `f_to_c_string`) handle null-terminated C strings to/from Fortran character arrays
- [ ] **CBIND-04**: Singleton guard in `register_bmi` prevents second allocation (WRF-Hydro module globals cannot support multiple instances; returns `BMI_FAILURE` on second call)

### Python Testing

- [ ] **PYTEST-01**: Python ctypes test script loads `libwrfhydro_bmi.so` and exercises full IRF cycle: `register_bmi` -> `initialize` -> `update` (multiple steps) -> `get_value` -> `finalize`
- [ ] **PYTEST-02**: Python test validates Croton NY channel streamflow values match the Fortran 151-test suite reference output (bit-for-bit or within tolerance)
- [ ] **PYTEST-03**: MPI `RTLD_GLOBAL` requirement handled via `ctypes.CDLL("libmpi.so", ctypes.RTLD_GLOBAL)` before loading BMI library (prevents Open MPI segfault)
- [ ] **PYTEST-04**: Python test queries grid sizes dynamically from BMI functions (`get_grid_size`, `get_var_nbytes`) instead of hardcoding Croton NY dimensions

### Documentation

- [ ] **DOC-01**: Full Doc 16 in `bmi_wrf_hydro/Docs/` covering shared library architecture, C binding patterns (box/opaque handle), build instructions (CMake + build.sh), Python ctypes usage, troubleshooting — with emojis, ASCII/Mermaid diagrams, ML analogies per project style

## v2 Requirements

Deferred to Phase 2 (babelizer) or later. Tracked but not in current roadmap.

### Babelizer Integration

- **BABEL-01**: `babel.toml` configuration file with `library = "bmiwrfhydrof"`, `entry_point = "bmi_wrf_hydro"`
- **BABEL-02**: `babelize init babel.toml` generates `pymt_wrfhydro` Python package
- **BABEL-03**: bmi-tester validation passes on babelized plugin

### NextGen Compatibility

- **NGEN-01**: `#ifdef NGEN_ACTIVE` guard in `bmi_interop.f90` for NOAA NextGen framework
- **NGEN-02**: NextGen-specific `register_bmi` variant compatible with ngen BMI interface

### Production Quality

- **PROD-01**: CTest integration running 151-test suite against shared library (not static objects)
- **PROD-02**: Multi-instance support (requires WRF-Hydro source changes — out of scope)
- **PROD-03**: `get_value_ptr` working implementation (requires WRF-Hydro REAL→double change)

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Modifying WRF-Hydro source code (beyond -fPIC rebuild) | BMI is non-invasive by design; wrapper calls model as-is |
| PyMT plugin registration | Phase 3, depends on babelizer completing first |
| SCHISM coupling | Phase 4, depends on both models being babelized |
| MPI parallel execution (np > 1) | Serial mode only for this milestone; parallel is future work |
| Windows .dll support | WSL2 Linux .so is the target platform |
| Full bmi-tester compliance | Nice-to-have for v2; not blocking shared library |
| Real-time chat/video features | Not applicable to scientific model coupling |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| BUILD-01 | Phase ? | Pending |
| BUILD-02 | Phase ? | Pending |
| BUILD-03 | Phase ? | Pending |
| BUILD-04 | Phase ? | Pending |
| BUILD-05 | Phase ? | Pending |
| CBIND-01 | Phase ? | Pending |
| CBIND-02 | Phase ? | Pending |
| CBIND-03 | Phase ? | Pending |
| CBIND-04 | Phase ? | Pending |
| PYTEST-01 | Phase ? | Pending |
| PYTEST-02 | Phase ? | Pending |
| PYTEST-03 | Phase ? | Pending |
| PYTEST-04 | Phase ? | Pending |
| DOC-01 | Phase ? | Pending |

**Coverage:**
- v1 requirements: 14 total
- Mapped to phases: 0
- Unmapped: 14

---
*Requirements defined: 2026-02-23*
*Last updated: 2026-02-23 after initial definition*
