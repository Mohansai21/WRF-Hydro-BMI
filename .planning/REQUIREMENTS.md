# Requirements: WRF-Hydro BMI Shared Library

**Defined:** 2026-02-23
**Revised:** 2026-02-23 (post-research: babelizer generates C bindings, descoped full interop layer)
**Core Value:** WRF-Hydro must be callable from Python through a shared library -- gateway to Phase 2 (babelizer) and coupled simulations

## v1 Requirements

Requirements for the shared library milestone. Each maps to roadmap phases.

### Build Infrastructure

- [x] **BUILD-01**: WRF-Hydro 22 static libraries recompiled with `-fPIC` (`CMAKE_POSITION_INDEPENDENT_CODE=ON`) so they can be linked into a shared library
- [x] **BUILD-02**: `libwrfhydrobmi.so` builds successfully via CMake, linking all 22 WRF-Hydro static libs + BMI + NetCDF + MPI with no unresolved symbols
- [x] **BUILD-03**: `build.sh` updated with shared library target (`-shared` flag) for fast dev iteration builds
- [x] **BUILD-04**: `cmake --install` places `libwrfhydrobmi.so`, `.mod` files, and `.pc` file into `$CONDA_PREFIX/{lib,include,lib/pkgconfig}`
- [x] **BUILD-05**: pkg-config `.pc` file generated by CMake (template from `bmi-example-fortran`) enabling babelizer discovery via `pkg-config bmiwrfhydrof`

### C Binding Layer (Minimal -- Test Infrastructure Only)

The babelizer auto-generates its own 818-line `bmi_interoperability.f90` with full ISO_C_BINDING wrappers for all 41 BMI functions. We do NOT write that layer. Instead, we write a minimal C binding (~100-200 lines) solely for pre-babelizer Python ctypes validation. This is test infrastructure, not production code.

- [x] **CBIND-01**: Minimal `bmi_wrf_hydro_c.f90` with `bind(C)` wrappers for 8-10 key BMI functions: `register_bmi`, `initialize`, `update`, `update_until`, `finalize`, `get_component_name`, `get_value_double` (for channel streamflow), `get_grid_size`, `get_var_nbytes`, `get_current_time`
- [x] **CBIND-03**: String conversion helpers (`c_to_f_string`, `f_to_c_string`) for the minimal wrapper to handle null-terminated C strings to/from Fortran character arrays
- [x] **CBIND-04**: Singleton guard in `register_bmi` prevents second allocation (WRF-Hydro module globals cannot support multiple instances; returns error code on second call)

### Python Testing

- [ ] **PYTEST-01**: Python ctypes test script loads `libwrfhydrobmi.so` and exercises full IRF cycle via the minimal C bindings: `register_bmi` -> `initialize` -> `update` (multiple steps) -> `get_value` -> `finalize`
- [ ] **PYTEST-02**: Python test validates Croton NY channel streamflow values match the Fortran 151-test suite reference output (bit-for-bit or within tolerance)
- [ ] **PYTEST-03**: MPI `RTLD_GLOBAL` requirement handled via `ctypes.CDLL("libmpi.so", ctypes.RTLD_GLOBAL)` before loading BMI library (prevents Open MPI segfault)
- [ ] **PYTEST-04**: Python test queries grid sizes dynamically from BMI functions (`get_grid_size`, `get_var_nbytes`) instead of hardcoding Croton NY dimensions

### Documentation

- [ ] **DOC-01**: Full Doc 16 in `bmi_wrf_hydro/Docs/` covering shared library architecture, minimal C binding rationale (vs babelizer auto-generated layer), build instructions (CMake + build.sh), Python ctypes usage, babelizer readiness checklist, troubleshooting -- with emojis, ASCII/Mermaid diagrams, ML analogies per project style

## v2 Requirements

Deferred to Phase 2 (babelizer) or later. Tracked but not in current roadmap.

### Babelizer Integration

- **BABEL-01**: `babel.toml` configuration file with `library = "bmiwrfhydrof"`, `entry_point = "bmi_wrf_hydro"`
- **BABEL-02**: `babelize init babel.toml` generates `pymt_wrfhydro` Python package
- **BABEL-03**: bmi-tester validation passes on babelized plugin

### NextGen Compatibility

- **NGEN-01**: Full `iso_c_bmi.f90` with ISO_C_BINDING `bind(C)` wrappers for all 41 BMI functions (what was originally CBIND-01 before descoping)
- **NGEN-02**: `register_bmi()` with box/opaque-handle pattern for NOAA NextGen framework adapter
- **NGEN-03**: `#ifdef NGEN_ACTIVE` guard for NextGen-specific code paths

### Production Quality

- **PROD-01**: CTest integration running 151-test suite against shared library (not static objects)
- **PROD-02**: Multi-instance support (requires WRF-Hydro source changes -- out of scope)
- **PROD-03**: `get_value_ptr` working implementation (requires WRF-Hydro REAL->double change)

## Descoped from v1 (Moved to v2)

These requirements were in the original v1 but descoped after research confirmed the babelizer generates its own C interoperability layer:

| Original Req | What It Was | Why Descoped | New Location |
|-------------|-------------|--------------|--------------|
| CBIND-01 (original) | Full ISO_C_BINDING for all 41 BMI functions | Babelizer auto-generates 818-line bmi_interoperability.f90 | NGEN-01 (v2) |
| CBIND-02 | `register_bmi` + box/opaque-handle pattern | Not needed for PyMT/babelizer pathway; only for NextGen | NGEN-02 (v2) |
| CBIND-03 (original) | Full string conversion helpers | Babelizer handles all string marshalling | Partially kept as CBIND-03 (minimal) |

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Modifying WRF-Hydro source code (beyond -fPIC rebuild) | BMI is non-invasive by design; wrapper calls model as-is |
| Full 41-function ISO_C_BINDING layer | Babelizer generates this automatically; writing it is wasted effort for PyMT pathway |
| register_bmi with box/opaque-handle pattern | Only needed for NOAA NextGen, not babelizer/PyMT |
| PyMT plugin registration | Phase 3 of overall project, depends on babelizer completing first |
| SCHISM coupling | Phase 4 of overall project, depends on both models being babelized |
| MPI parallel execution (np > 1) | Serial mode only for this milestone; parallel is future work |
| Windows .dll support | WSL2 Linux .so is the target platform |
| Full bmi-tester compliance | Nice-to-have for v2; not blocking shared library |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| BUILD-01 | Phase 1 | Complete |
| BUILD-02 | Phase 2 | Complete |
| BUILD-03 | Phase 2 | Complete |
| BUILD-04 | Phase 2 | Complete |
| BUILD-05 | Phase 2 | Complete |
| CBIND-01 | Phase 3 | Complete |
| CBIND-03 | Phase 3 | Complete |
| CBIND-04 | Phase 3 | Complete |
| PYTEST-01 | Phase 3 | Pending |
| PYTEST-02 | Phase 3 | Pending |
| PYTEST-03 | Phase 3 | Pending |
| PYTEST-04 | Phase 3 | Pending |
| DOC-01 | Phase 4 | Pending |

**Coverage:**
- v1 requirements: 13 total
- Mapped to phases: 13
- Unmapped: 0

---
*Requirements defined: 2026-02-23*
*Last updated: 2026-02-23 after roadmap revision (babelizer research findings)*
