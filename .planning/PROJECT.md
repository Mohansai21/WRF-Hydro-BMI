# WRF-Hydro BMI — Babelizer & PyMT Integration

## What This Is

A Python-callable WRF-Hydro BMI plugin (`pymt_wrfhydro`) generated by the CSDMS babelizer from the existing shared library (`libbmiwrfhydrof.so`). This transforms WRF-Hydro from a Fortran-only model into a PyMT component that scientists can control from Python/Jupyter, enabling future coupling with SCHISM for compound flooding simulations.

## Core Value

WRF-Hydro must be controllable from Python via PyMT — `babelize init babel.toml` must produce a working `pymt_wrfhydro` package that passes bmi-tester and reproduces Croton NY reference results.

## Current Milestone: v2.0 Babelizer

**Goal:** Babelize WRF-Hydro's shared library into a pymt_wrfhydro Python package, validated against Croton NY reference data.

**Target features:**
- babel.toml configuration for WRF-Hydro BMI
- `babelize init` generates pymt_wrfhydro Python package
- pymt_wrfhydro builds, installs, and imports in Python
- bmi-tester passes on the babelized plugin
- Croton NY results from pymt_wrfhydro match Fortran reference output

## Requirements

### Validated

<!-- Shipped and confirmed valuable. v1.0 Shared Library milestone. -->

- ✓ BMI wrapper implements all 41 BMI functions — `bmi_wrf_hydro/src/bmi_wrf_hydro.f90` (~1919 lines)
- ✓ 151-test suite passes for all BMI categories — `bmi_wrf_hydro/tests/bmi_wrf_hydro_test.f90`
- ✓ 8 output + 4 input variables exposed via CSDMS Standard Names
- ✓ 3 grid types (1km LSM, 250m routing, vector channel) all tested
- ✓ Initialize-Run-Finalize pattern working with WRF-Hydro (Croton NY, 6hr)
- ✓ `libbmiwrfhydrof.so` (4.8 MB) built + installed to `$CONDA_PREFIX/lib/`
- ✓ C binding layer (`bmi_wrf_hydro_c.f90`) with 10 key BMI functions exported
- ✓ pkg-config discovery (`bmiwrfhydrof.pc`) ready for babelizer
- ✓ Python ctypes test validates Croton NY streamflow end-to-end
- ✓ Doc 16 covering shared library architecture + babelizer readiness

### Active

<!-- Current scope. Building toward these. See REQUIREMENTS.md for details. -->

(Defined in REQUIREMENTS.md after milestone scoping)

### Out of Scope

<!-- Explicit boundaries. Includes reasoning to prevent re-adding. -->

- SCHISM babelization — SCHISM BMI targets NextGen, not PyMT; needs separate assessment
- PyMT coupling (WRF-Hydro + SCHISM) — Phase 4 of overall project, depends on both models
- MPI parallel execution — serial mode only (np=1), following SCHISM's approach
- Modifying WRF-Hydro source code — BMI is non-invasive by design
- Multi-instance support — WRF-Hydro module globals prevent multiple instances

## Context

- **Shared library ready:** `libbmiwrfhydrof.so` installed at `$CONDA_PREFIX/lib/` with pkg-config
- **Babelizer reference:** bmi-example-fortran was babelized as `pymt_heatf` — proven pattern
- **Test infrastructure:** Croton NY test case at `WRF_Hydro_Run_Local/run/`
- **Doc 16 babelizer readiness checklist:** 7 verification commands with expected outputs
- **Build environment:** conda wrfhydro-bmi (gfortran 14.3.0, OpenMPI 5.0.8, bmi-fortran 2.0.3)
- **Key insight:** Babelizer auto-generates 818-line `bmi_interoperability.f90` — our C binding is test-only
- **CSDMS ecosystem:** babelizer 0.5+, pymt 1.3+, bmi-tester via conda-forge

## Constraints

- **Tech stack**: Python (babelizer, pymt, bmi-tester) + existing Fortran shared library
- **Compatibility**: pymt_wrfhydro must link against existing `libbmiwrfhydrof.so`
- **Serial only**: MPI required for linking but execution is single-process
- **Test data**: Croton NY test case required for validation
- **Platform**: WSL2 Linux
- **Naming**: Library named `bmiwrfhydrof` following CSDMS `bmi{model}f` convention

## Key Decisions

<!-- Decisions that constrain future work. Add throughout project lifecycle. -->

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| CMake as primary build + keep build.sh | CMake needed for babelizer, build.sh for fast dev iteration | ✓ Good |
| Follow bmi-example-fortran C binding pattern | Proven pattern in CSDMS ecosystem, babelizer expects it | ✓ Good |
| Library named bmiwrfhydrof (bmi{model}f convention) | Required by babelizer for automatic discovery | ✓ Good |
| Minimal C binding (10 functions) for testing only | Babelizer generates full 41-function interop layer automatically | ✓ Good |
| WRF-Hydro only for v2.0 (no SCHISM) | SCHISM BMI targets NextGen, not PyMT pathway | — Pending |
| Full validation (bmi-tester + Croton NY) | Ensures babelized plugin is production-ready | — Pending |

---
*Last updated: 2026-02-24 after v2.0 milestone start*
